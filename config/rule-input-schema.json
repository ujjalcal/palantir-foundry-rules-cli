{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://palantir.com/foundry-rules/rule-input-schema.json",
  "title": "Foundry Rules Input Schema",
  "description": "Schema for rule input files used by foundry-rules-cli. Supports two formats: template-based (simple) and raw logic (advanced).",
  "oneOf": [
    { "$ref": "#/definitions/templateBasedInput" },
    { "$ref": "#/definitions/rawLogicInput" }
  ],
  "definitions": {
    "templateBasedInput": {
      "type": "object",
      "title": "Template-Based Input",
      "description": "Simple format using predefined templates. The CLI builds the full rule logic from template + params.",
      "required": ["template", "params"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Human-readable name for the rule",
          "minLength": 1,
          "maxLength": 200,
          "examples": ["High-Priority-Items", "Active-Categories-Filter"]
        },
        "description": {
          "type": "string",
          "description": "Detailed description of what the rule does",
          "maxLength": 500,
          "examples": ["Filter items with high priority status for review"]
        },
        "keywords": {
          "type": "string",
          "description": "Comma-separated keywords for categorization and search",
          "pattern": "^[a-zA-Z0-9-_,]+$",
          "examples": ["priority,high,filter"]
        },
        "template": {
          "type": "string",
          "description": "Name of the template to use for building rule logic. Options: string-equals (propertyId == value), string-or (propertyId IN [values]), numeric-range (min <= propertyId <= max), null-check (is null/not null)",
          "enum": ["string-equals", "string-or", "numeric-range", "null-check"]
        },
        "params": {
          "type": "object",
          "description": "Template-specific parameters",
          "oneOf": [
            { "$ref": "#/definitions/stringEqualsParams" },
            { "$ref": "#/definitions/stringOrParams" },
            { "$ref": "#/definitions/numericRangeParams" },
            { "$ref": "#/definitions/nullCheckParams" }
          ]
        }
      }
    },
    "stringEqualsParams": {
      "type": "object",
      "title": "String Equals Parameters",
      "description": "Parameters for string-equals template",
      "required": ["propertyId", "value"],
      "additionalProperties": false,
      "properties": {
        "propertyId": {
          "type": "string",
          "description": "The property ID to filter on (from object type definition)",
          "examples": ["status", "category", "amount"]
        },
        "value": {
          "type": "string",
          "description": "The value to match",
          "examples": ["active", "pending", "high"]
        },
        "caseSensitive": {
          "type": "boolean",
          "description": "Whether comparison is case-sensitive",
          "default": false
        }
      }
    },
    "stringOrParams": {
      "type": "object",
      "title": "String OR Parameters",
      "description": "Parameters for string-or template (matches any of multiple values)",
      "required": ["propertyId", "values"],
      "additionalProperties": false,
      "properties": {
        "propertyId": {
          "type": "string",
          "description": "The property ID to filter on"
        },
        "values": {
          "type": "array",
          "description": "List of values to match (OR logic)",
          "items": { "type": "string" },
          "minItems": 1,
          "examples": [["electronics", "software", "services"]]
        },
        "caseSensitive": {
          "type": "boolean",
          "description": "Whether comparison is case-sensitive",
          "default": false
        }
      }
    },
    "numericRangeParams": {
      "type": "object",
      "title": "Numeric Range Parameters",
      "description": "Parameters for numeric-range template. At least one of min or max required.",
      "required": ["propertyId"],
      "additionalProperties": false,
      "properties": {
        "propertyId": {
          "type": "string",
          "description": "The property ID to filter on"
        },
        "min": {
          "type": "number",
          "description": "Minimum value (inclusive)"
        },
        "max": {
          "type": "number",
          "description": "Maximum value (inclusive)"
        }
      },
      "anyOf": [
        { "required": ["min"] },
        { "required": ["max"] }
      ]
    },
    "nullCheckParams": {
      "type": "object",
      "title": "Null Check Parameters",
      "description": "Parameters for null-check template",
      "required": ["propertyId"],
      "additionalProperties": false,
      "properties": {
        "propertyId": {
          "type": "string",
          "description": "The property ID to check for null"
        },
        "isNull": {
          "type": "boolean",
          "description": "If true, matches NULL values. If false, matches NOT NULL values.",
          "default": true
        }
      }
    },
    "rawLogicInput": {
      "type": "object",
      "title": "Raw Logic Input",
      "description": "Advanced format with full rule logic structure. Use when templates don't cover your use case.",
      "required": ["grammarVersion", "workflowRid", "strategy", "effect"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Human-readable name for the rule (optional for raw logic)"
        },
        "description": {
          "type": "string",
          "description": "Detailed description of what the rule does"
        },
        "keywords": {
          "type": "string",
          "description": "Comma-separated keywords for categorization"
        },
        "grammarVersion": {
          "type": "string",
          "description": "Rule grammar version",
          "const": "V1"
        },
        "namedStrategies": {
          "type": "object",
          "description": "Named strategy definitions for reuse",
          "default": {}
        },
        "strategyComponents": {
          "description": "Strategy components (typically null)",
          "default": null
        },
        "workflowRid": {
          "type": "string",
          "description": "Foundry workflow RID",
          "pattern": "^ri\\.taurus\\.main\\.workflow\\.[a-f0-9-]+$",
          "examples": ["ri.taurus.main.workflow.f4c74a0a-583c-4499-aba3-1989b7f0a273"]
        },
        "strategy": {
          "$ref": "#/definitions/strategy"
        },
        "effect": {
          "$ref": "#/definitions/effect"
        }
      }
    },
    "strategy": {
      "type": "object",
      "description": "Rule strategy definition",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "description": "Strategy type",
          "enum": ["filterNode", "windowNode", "aggregationNode"]
        },
        "filterNode": {
          "$ref": "#/definitions/filterNode"
        },
        "windowNode": {
          "type": "object",
          "description": "Window node definition (for time-based rules)"
        },
        "aggregationNode": {
          "type": "object",
          "description": "Aggregation node definition (for aggregate rules)"
        }
      }
    },
    "filterNode": {
      "type": "object",
      "description": "Filter node definition",
      "required": ["nodeInput", "filter"],
      "properties": {
        "nodeInput": {
          "type": "object",
          "required": ["type", "source"],
          "properties": {
            "type": {
              "type": "string",
              "const": "source"
            },
            "source": {
              "type": "object",
              "required": ["type", "objectTypeId"],
              "properties": {
                "type": {
                  "type": "string",
                  "const": "objectTypeId"
                },
                "objectTypeId": {
                  "type": "string",
                  "description": "Object type ID from workflow config",
                  "examples": ["namespace.your-object-type", "namespace.demo-product"]
                }
              }
            }
          }
        },
        "filter": {
          "$ref": "#/definitions/filterRule"
        },
        "joinFilterInputs": {
          "type": "object",
          "default": {}
        }
      }
    },
    "filterRule": {
      "type": "object",
      "description": "Filter rule definition",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["columnFilterRule", "andFilterRule", "orFilterRule", "notFilterRule"]
        }
      },
      "oneOf": [
        { "$ref": "#/definitions/columnFilterRule" },
        { "$ref": "#/definitions/andFilterRule" },
        { "$ref": "#/definitions/orFilterRule" }
      ]
    },
    "columnFilterRule": {
      "type": "object",
      "required": ["type", "columnFilterRule"],
      "properties": {
        "type": { "const": "columnFilterRule" },
        "columnFilterRule": {
          "type": "object",
          "required": ["column", "filter"],
          "properties": {
            "column": {
              "type": "object",
              "required": ["type", "objectProperty"],
              "properties": {
                "type": { "const": "objectProperty" },
                "objectProperty": {
                  "type": "object",
                  "required": ["objectTypeId", "propertyTypeId"],
                  "properties": {
                    "objectTypeId": { "type": "string" },
                    "propertyTypeId": { "type": "string" }
                  }
                }
              }
            },
            "filter": {
              "$ref": "#/definitions/columnFilter"
            }
          }
        }
      }
    },
    "andFilterRule": {
      "type": "object",
      "required": ["type", "andFilterRule"],
      "properties": {
        "type": { "const": "andFilterRule" },
        "andFilterRule": {
          "type": "object",
          "required": ["filters"],
          "properties": {
            "filters": {
              "type": "array",
              "items": { "$ref": "#/definitions/filterRule" },
              "minItems": 1
            }
          }
        }
      }
    },
    "orFilterRule": {
      "type": "object",
      "required": ["type", "orFilterRule"],
      "properties": {
        "type": { "const": "orFilterRule" },
        "orFilterRule": {
          "type": "object",
          "required": ["filters"],
          "properties": {
            "filters": {
              "type": "array",
              "items": { "$ref": "#/definitions/filterRule" },
              "minItems": 1
            }
          }
        }
      }
    },
    "columnFilter": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["stringColumnFilter", "numericColumnFilter", "nullColumnFilter"]
        }
      },
      "oneOf": [
        { "$ref": "#/definitions/stringColumnFilter" },
        { "$ref": "#/definitions/numericColumnFilter" },
        { "$ref": "#/definitions/nullColumnFilter" }
      ]
    },
    "stringColumnFilter": {
      "type": "object",
      "required": ["type", "stringColumnFilter"],
      "properties": {
        "type": { "const": "stringColumnFilter" },
        "stringColumnFilter": {
          "type": "object",
          "required": ["type", "values"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["EQUALS", "CONTAINS", "MATCHES", "EQUALS_WITH_WILDCARDS"],
              "description": "String comparison type"
            },
            "caseSensitive": {
              "type": "boolean",
              "default": false
            },
            "ignoreWhitespace": {
              "type": "boolean",
              "default": false
            },
            "values": {
              "type": "array",
              "items": { "type": "string" },
              "minItems": 1
            },
            "macro": {
              "$ref": "#/definitions/macro"
            }
          }
        }
      }
    },
    "numericColumnFilter": {
      "type": "object",
      "required": ["type", "numericColumnFilter"],
      "properties": {
        "type": { "const": "numericColumnFilter" },
        "numericColumnFilter": {
          "type": "object",
          "required": ["type", "values"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["EQUALS", "GREATER_THAN", "LESS_THAN", "GREATER_THAN_OR_EQUAL", "LESS_THAN_OR_EQUAL"],
              "description": "Numeric comparison type"
            },
            "values": {
              "type": "array",
              "items": { "type": "number" },
              "minItems": 1
            },
            "macro": {
              "$ref": "#/definitions/macro"
            }
          }
        }
      }
    },
    "nullColumnFilter": {
      "type": "object",
      "required": ["type", "nullColumnFilter"],
      "properties": {
        "type": { "const": "nullColumnFilter" },
        "nullColumnFilter": {
          "type": "object",
          "required": ["type"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["NULL", "NOT_NULL"]
            }
          }
        }
      }
    },
    "macro": {
      "type": "object",
      "description": "Macro configuration for filter values",
      "properties": {
        "function": {
          "type": "string",
          "default": "VALUE"
        },
        "inputType": {
          "type": "string",
          "default": "ALL_TYPES"
        },
        "outputType": {
          "type": "string",
          "default": "ALL_TYPES"
        }
      }
    },
    "effect": {
      "type": "object",
      "description": "Rule effect definition",
      "required": ["type", "v2"],
      "properties": {
        "type": {
          "type": "string",
          "const": "v2"
        },
        "v2": {
          "type": "object",
          "required": ["outputAndVersion"],
          "properties": {
            "outputAndVersion": {
              "type": "object",
              "required": ["outputId", "outputVersion", "workflowRid"],
              "properties": {
                "outputId": {
                  "type": "string",
                  "description": "Output ID from workflow config",
                  "pattern": "^[a-f0-9-]+$"
                },
                "outputVersion": {
                  "type": "string",
                  "description": "Output version",
                  "examples": ["0.1.0"]
                },
                "workflowRid": {
                  "type": "string",
                  "description": "Workflow RID (must match top-level workflowRid)"
                }
              }
            },
            "parameterValues": {
              "type": "object",
              "description": "Output parameter values",
              "default": {}
            }
          }
        }
      }
    }
  },
  "examples": [
    {
      "name": "High-Priority-Items",
      "description": "Filter items with high priority status for review",
      "keywords": "priority,high,filter",
      "template": "string-equals",
      "params": {
        "propertyId": "status",
        "value": "high"
      }
    },
    {
      "name": "Active-Categories-Filter",
      "description": "Match items in specific categories",
      "keywords": "category,filter,multiple",
      "template": "string-or",
      "params": {
        "propertyId": "category",
        "values": ["electronics", "software", "services"]
      }
    }
  ]
}
